# ハッシュ化によるパスワードセキュリティ


## ハッシュ化 (Hashing)

- **定義**: パスワードを一方向の関数（ハッシュ関数）に通して、元のパスワードから推測が困難な固定長の文字列（ハッシュ値）を生成する手法。
- **目的**: 平文のパスワードを直接保存するのではなく、ハッシュ値を保存することでセキュリティを高める。
- **注意点**: 単純なハッシュ化だけでは、レインボーテーブルや辞書攻撃に弱い。
- **例**: SHA-256, SHA-3, bcrypt など。

## ソルト (Salt)

- **定義**: ランダムな文字列（ソルト）を生成し、それを元のパスワードに追加（接続）する。
- **目的**: 同じパスワードでもハッシュ値が異なるようにすることで、レインボーテーブル攻撃や辞書攻撃を防ぐ。
- **保存**: ソルトはユーザーごとに異なるものを生成し、データベースに保存します。それ自体を秘密にする必要は通常ありません。
  
## ペッパー (Pepper)

- **定義**: ソルトと同じく、文字列（ペッパー）をパスワードに追加するが、この値は全てのパスワードで共通とする。
- **目的**: ソルトと同様にハッシュ値をユニークにするが、ペッパーは秘密情報として扱い、データベースが単独で漏洩しても安全。
- **保存**: ソースコードや専用の安全な場所（HSMなど）に保存する必要がある。

## ストレッチング (Stretching)

- **定義**: ハッシュ関数を複数回（N回）適用すること。
- **目的**: ブルートフォース攻撃やレインボーテーブル攻撃に対する耐性を高める。多くの計算が必要になるため、攻撃者にとってはより多くのリソースが必要。
- **注意点**: ストレッチングの回数（N）は、セキュリティとパフォーマンスのトレードオフに注意しながら選ぶ。
- **例**: PBKDF2, Argon2 など。

---





## 初回登録時のフローチャート
``` plantuml
@startuml
|アプリケーション|
start
:ユーザーIDとパスワードを受け取る;
|暗号ライブラリ|
:ランダムなソルトを生成;
|アプリケーション|
:ソルトとペッパーをパスワードに追加;
|暗号ライブラリ|
:ストレッチング用に複数回ハッシュ化;
|データベース|
:ユーザーID, ハッシュ化されたパスワード, ソルトを保存;
|アプリケーション|
:登録成功メッセージを返す;
stop
@enduml

```
1. **アプリケーション**: ユーザーからユーザーIDと平文のパスワードを受け取る。
2. **アプリケーション**: ソルトをランダムに生成する。
3. **アプリケーション**: ペッパーを設定値（コード内や環境変数）から取得する。
4. **アプリケーション**: ソルトとペッパーを平文のパスワードに追加する。
5. **暗号ライブラリ**: ストレッチングの回数（イテレーション）を設定する。
6. **暗号ライブラリ**: ハッシュ関数を適用し、ハッシュ値を生成する。この過程でストレッチングも適用される。
7. **アプリケーション**: 生成されたハッシュ値、ソルト、（オプションで）ストレッチングの回数をデータベースに保存する。
8. **データベース**: ユーザーID, ハッシュ値, ソルト（, ストレッチングの回数）を保存する。



## ログイン照会時のフローチャート

``` plantuml
@startuml
|アプリケーション|
start
:ユーザーIDとパスワードを受け取る;
|暗号ライブラリ|
|データベース|
:ユーザーIDに対応する\nハッシュ化されたパスワードとソルトを取得;
|アプリケーション|
:ソルトとペッパーを受け取ったパスワードに追加;
|暗号ライブラリ|
:パスワードをハッシュ化;
|アプリケーション|
if (ハッシュ化されたパスワードが一致?) then (はい)
    :成功メッセージを返す;
else (いいえ)
    :失敗メッセージを返す;
endif
stop
@enduml

```

1. **アプリケーション**: ユーザーからユーザーIDと平文のパスワードを受け取る。
2. **データベース**: ユーザーIDに紐づくハッシュ値、ソルト（, ストレッチングの回数）を取得する。
3. **アプリケーション**: ペッパーを設定値（コード内や環境変数）から取得する。
4. **アプリケーション**: 取得したソルトとペッパーを平文のパスワードに追加する。
5. **暗号ライブラリ**: ストレッチングの回数（イテレーション）を設定する（データベースから取得した場合）。
6. **暗号ライブラリ**: ハッシュ関数を適用し、ハッシュ値を生成する。この過程でストレッチングも適用される。
7. **アプリケーション**: 生成されたハッシュ値とデータベースから取得したハッシュ値が一致するか確認する。
8. **アプリケーション**: 一致した場合はログイン成功、そうでなければログイン失敗。
